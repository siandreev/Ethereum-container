#!/bin/bash
    cd "$(dirname "$0")"
    ip=$(hostname -i)
    (geth --datadir node1 --nousb --unlock 0 --password node1/node1.password --rpc -rpcapi eth,web3,personal,admin --rpccorsdomain '*' --nat extip:`hostname -i` --maxpendpeers 4 --mine --minerthreads 1 --allow-insecure-unlock --port 30311 --rpcaddr "0.0.0.0" --rpcport 8541 --networkid 191 --miner.etherbase 0x073CFa4b6635b1A1B96F6363a9e499a8076B6107 --syncmode 'full' --ipcdisable &> node1.log &) 
    sleep 3
    full_enode1=$(geth --exec "admin.nodeInfo.enode" attach http://$ip:8541)
    enode1=$(expr substr $full_enode1 1 $(($(expr index $full_enode1 "@") - 1)))'@127.0.0.1:30311"'
    (geth --datadir node2 --nousb --unlock 0 --password node2/node2.password --rpc -rpcapi eth,web3,personal,admin --rpccorsdomain '*' --nat extip:`hostname -i`  --maxpendpeers 4 --mine --minerthreads 1 --allow-insecure-unlock --port 30312 --rpcaddr "0.0.0.0" --rpcport 8542 --networkid 191 --miner.etherbase 0x0Ce59225BCD447fEaEd698ED754D309febA5fC63 --syncmode 'full' --ipcdisable &> node2.log &)
    sleep 3
    $(geth --exec "admin.addPeer($enode1)" attach http://$ip:8542)  
    while ! ( ( grep -q 'number=3' ./node1.log ) && ( grep -q 'number=3' ./node2.log) )
	do
		sleep 2
		echo "Waiting for node..."
	done

    contract="var total = 1200 ;var erc20_coinContract = web3.eth.contract([{'inputs':[{'internalType':'uint256','name':'total','type':'uint256'}],'payable':false,'stateMutability':'nonpayable','type':'constructor'},{'anonymous':false,'inputs':[{'indexed':true,'internalType':'address','name':'tokenOwner','type':'address'},{'indexed':true,'internalType':'address','name':'spender','type':'address'},{'indexed':false,'internalType':'uint256','name':'tokens','type':'uint256'}],'name':'Approval','type':'event'},{'anonymous':false,'inputs':[{'indexed':true,'internalType':'address','name':'from','type':'address'},{'indexed':true,'internalType':'address','name':'to','type':'address'},{'indexed':false,'internalType':'uint256','name':'tokens','type':'uint256'}],'name':'Transfer','type':'event'},{'constant':true,'inputs':[{'internalType':'address','name':'owner','type':'address'},{'internalType':'address','name':'delegate','type':'address'}],'name':'allowance','outputs':[{'internalType':'uint256','name':'','type':'uint256'}],'payable':false,'stateMutability':'view','type':'function'},{'constant':false,'inputs':[{'internalType':'address','name':'delegate','type':'address'},{'internalType':'uint256','name':'numTokens','type':'uint256'}],'name':'approve','outputs':[{'internalType':'bool','name':'','type':'bool'}],'payable':false,'stateMutability':'nonpayable','type':'function'},{'constant':true,'inputs':[{'internalType':'address','name':'tokenOwner','type':'address'}],'name':'balanceOf','outputs':[{'internalType':'uint256','name':'','type':'uint256'}],'payable':false,'stateMutability':'view','type':'function'},{'constant':true,'inputs':[],'name':'decimals','outputs':[{'internalType':'uint8','name':'','type':'uint8'}],'payable':false,'stateMutability':'view','type':'function'},{'constant':true,'inputs':[],'name':'name','outputs':[{'internalType':'string','name':'','type':'string'}],'payable':false,'stateMutability':'view','type':'function'},{'constant':true,'inputs':[],'name':'symbol','outputs':[{'internalType':'string','name':'','type':'string'}],'payable':false,'stateMutability':'view','type':'function'},{'constant':true,'inputs':[],'name':'totalSupply','outputs':[{'internalType':'uint256','name':'','type':'uint256'}],'payable':false,'stateMutability':'view','type':'function'},{'constant':false,'inputs':[{'internalType':'address','name':'receiver','type':'address'},{'internalType':'uint256','name':'numTokens','type':'uint256'}],'name':'transfer','outputs':[{'internalType':'bool','name':'','type':'bool'}],'payable':false,'stateMutability':'nonpayable','type':'function'},{'constant':false,'inputs':[{'internalType':'address','name':'owner','type':'address'},{'internalType':'address','name':'buyer','type':'address'},{'internalType':'uint256','name':'numTokens','type':'uint256'}],'name':'transferFrom','outputs':[{'internalType':'bool','name':'','type':'bool'}],'payable':false,'stateMutability':'nonpayable','type':'function'}]);var erc20_coin = erc20_coinContract.new(total,{from: web3.eth.accounts[0], data: '0x60806040523480156200001157600080fd5b5060405162000fc138038062000fc1833981810160405260208110156200003757600080fd5b81019080805190602001909291905050508060028190555060c8600254036000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055506000620000c36040518060600160405280602a815260200162000f97602a91396200011160201b60201c565b905060c86000808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000208190555050506200037e565b6000606082905060008090506000806000600290505b602a8110156200037157610100840293508481815181106200014557fe5b602001015160f81c60f81b60f81c60ff1692508460018201815181106200016857fe5b602001015160f81c60f81b60f81c60ff16915060618373ffffffffffffffffffffffffffffffffffffffff1610158015620001ba575060668373ffffffffffffffffffffffffffffffffffffffff1611155b15620001cc576057830392506200026b565b60418373ffffffffffffffffffffffffffffffffffffffff16101580156200020b575060468373ffffffffffffffffffffffffffffffffffffffff1611155b156200021d576037830392506200026a565b60308373ffffffffffffffffffffffffffffffffffffffff16101580156200025c575060398373ffffffffffffffffffffffffffffffffffffffff1611155b1562000269576030830392505b5b5b60618273ffffffffffffffffffffffffffffffffffffffff1610158015620002aa575060668273ffffffffffffffffffffffffffffffffffffffff1611155b15620002bc576057820391506200035b565b60418273ffffffffffffffffffffffffffffffffffffffff1610158015620002fb575060468273ffffffffffffffffffffffffffffffffffffffff1611155b156200030d576037820391506200035a565b60308273ffffffffffffffffffffffffffffffffffffffff16101580156200034c575060398273ffffffffffffffffffffffffffffffffffffffff1611155b1562000359576030820391505b5b5b8160108402018401935060028101905062000127565b5082945050505050919050565b610c09806200038e6000396000f3fe608060405234801561001057600080fd5b50600436106100935760003560e01c8063313ce56711610066578063313ce5671461022557806370a082311461024957806395d89b41146102a1578063a9059cbb14610324578063dd62ed3e1461038a57610093565b806306fdde0314610098578063095ea7b31461011b57806318160ddd1461018157806323b872dd1461019f575b600080fd5b6100a0610402565b6040518080602001828103825283818151815260200191508051906020019080838360005b838110156100e05780820151818401526020810190506100c5565b50505050905090810190601f16801561010d5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6101676004803603604081101561013157600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff1690602001909291908035906020019092919050505061043b565b604051808215151515815260200191505060405180910390f35b61018961052d565b6040518082815260200191505060405180910390f35b61020b600480360360608110156101b557600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190803573ffffffffffffffffffffffffffffffffffffffff16906020019092919080359060200190929190505050610537565b604051808215151515815260200191505060405180910390f35b61022d6108b2565b604051808260ff1660ff16815260200191505060405180910390f35b61028b6004803603602081101561025f57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff1690602001909291905050506108b7565b6040518082815260200191505060405180910390f35b6102a96108ff565b6040518080602001828103825283818151815260200191508051906020019080838360005b838110156102e95780820151818401526020810190506102ce565b50505050905090810190601f1680156103165780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6103706004803603604081101561033a57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff16906020019092919080359060200190929190505050610938565b604051808215151515815260200191505060405180910390f35b6103ec600480360360408110156103a057600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050610b1a565b6040518082815260200191505060405180910390f35b6040518060400160405280600a81526020017f45524332305f436f696e0000000000000000000000000000000000000000000081525081565b600081600160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508273ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925846040518082815260200191505060405180910390a36001905092915050565b6000600254905090565b60008060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205482111561058457600080fd5b600160008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205482111561060d57600080fd5b61065e826000808773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054610ba190919063ffffffff16565b6000808673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000208190555061072f82600160008773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054610ba190919063ffffffff16565b600160008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550610800826000808673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054610bb890919063ffffffff16565b6000808573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508273ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef846040518082815260200191505060405180910390a3600190509392505050565b601281565b60008060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050919050565b6040518060400160405280600581526020017f455243323000000000000000000000000000000000000000000000000000000081525081565b60008060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205482111561098557600080fd5b6109d6826000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054610ba190919063ffffffff16565b6000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550610a69826000808673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054610bb890919063ffffffff16565b6000808573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508273ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef846040518082815260200191505060405180910390a36001905092915050565b6000600160008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905092915050565b600082821115610bad57fe5b818303905092915050565b600080828401905083811015610bca57fe5b809150509291505056fea265627a7a72315820f9166aa4c8c9e67db0c4918c7c0b6fbb956deadef68a82de010361cc6a906ccc64736f6c63430005110032305830434535393232354243443434374645414544363938454437353444333039464542413546433633', gas: '4700000'}, function (e, contract){console.log(e, contract);if (typeof contract.address !== 'undefined') {console.log('Contract mined! address: ' + contract.address + ' transactionHash: ' + contract.transactionHash);}})"

    geth --exec "$contract" attach http://$ip:8541 &> node1.log

    code=$(geth --exec "eth.getCode('0x70009254e451916fb5543d161768f489289384fb')" attach http://$ip:8541)

    while [ "$code" == "0x" ]
	do
		sleep 2
		echo "Waiting for contrract..."
        $code=$(geth --exec "eth.getCode('0x70009254e451916fb5543d161768f489289384fb')" attach http://$ip:8541)
        echo $code
	done

    echo "The node is ready!"
    sleep infinity