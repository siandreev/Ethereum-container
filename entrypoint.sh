#!/bin/bash
    cd "$(dirname "$0")"
    ip=$(hostname -i)
    (geth --datadir node1 --nousb --unlock 0 --password node1/node1.password --rpc -rpcapi eth,web3,personal,admin --rpccorsdomain '*' --nat extip:`hostname -i` --maxpendpeers 4 --mine --minerthreads 1 --allow-insecure-unlock --port 30311 --rpcaddr "0.0.0.0" --rpcport 8541 --networkid 191 --miner.etherbase 0x073CFa4b6635b1A1B96F6363a9e499a8076B6107 --syncmode 'full' --ipcdisable &> node1.log &) 
    sleep 3
    full_enode1=$(geth --exec "admin.nodeInfo.enode" attach http://$ip:8541)
    enode1=$(expr substr $full_enode1 1 $(($(expr index $full_enode1 "@") - 1)))'@127.0.0.1:30311"'
    (geth --datadir node2 --nousb --unlock 0 --password node2/node2.password --rpc -rpcapi eth,web3,personal,admin --rpccorsdomain '*' --nat extip:`hostname -i`  --maxpendpeers 4 --mine --minerthreads 1 --allow-insecure-unlock --port 30312 --rpcaddr "0.0.0.0" --rpcport 8542 --networkid 191 --miner.etherbase 0x0Ce59225BCD447fEaEd698ED754D309febA5fC63 --syncmode 'full' --ipcdisable &> node2.log &)
    sleep 3
    $(geth --exec "admin.addPeer($enode1)" attach http://$ip:8542)  
    while ! ( ( grep -q 'number=3' ./node1.log ) && ( grep -q 'number=3' ./node2.log) )
	do
		sleep 2
		echo "Waiting for node..."
	done

    contract="var total = 1200; var erc20_coinContract = web3.eth.contract([{'inputs':[{'internalType':'uint256','name':'total','type':'uint256'}],'payable':false,'stateMutability':'nonpayable','type':'constructor'},{'anonymous':false,'inputs':[{'indexed':true,'internalType':'address','name':'tokenOwner','type':'address'},{'indexed':true,'internalType':'address','name':'spender','type':'address'},{'indexed':false,'internalType':'uint256','name':'tokens','type':'uint256'}],'name':'Approval','type':'event'},{'anonymous':false,'inputs':[{'indexed':true,'internalType':'address','name':'from','type':'address'},{'indexed':true,'internalType':'address','name':'to','type':'address'},{'indexed':false,'internalType':'uint256','name':'tokens','type':'uint256'}],'name':'Transfer','type':'event'},{'constant':true,'inputs':[{'internalType':'address','name':'holder','type':'address'},{'internalType':'address','name':'delegate','type':'address'}],'name':'allowance','outputs':[{'internalType':'uint256','name':'','type':'uint256'}],'payable':false,'stateMutability':'view','type':'function'},{'constant':false,'inputs':[{'internalType':'address','name':'delegate','type':'address'},{'internalType':'uint256','name':'numTokens','type':'uint256'}],'name':'approve','outputs':[{'internalType':'bool','name':'','type':'bool'}],'payable':false,'stateMutability':'nonpayable','type':'function'},{'constant':true,'inputs':[{'internalType':'address','name':'tokenOwner','type':'address'}],'name':'balanceOf','outputs':[{'internalType':'uint256','name':'','type':'uint256'}],'payable':false,'stateMutability':'view','type':'function'},{'constant':true,'inputs':[],'name':'decimals','outputs':[{'internalType':'uint8','name':'','type':'uint8'}],'payable':false,'stateMutability':'view','type':'function'},{'constant':true,'inputs':[],'name':'name','outputs':[{'internalType':'string','name':'','type':'string'}],'payable':false,'stateMutability':'view','type':'function'},{'constant':true,'inputs':[],'name':'owner','outputs':[{'internalType':'address','name':'','type':'address'}],'payable':false,'stateMutability':'view','type':'function'},{'constant':true,'inputs':[],'name':'symbol','outputs':[{'internalType':'string','name':'','type':'string'}],'payable':false,'stateMutability':'view','type':'function'},{'constant':true,'inputs':[],'name':'totalSupply','outputs':[{'internalType':'uint256','name':'','type':'uint256'}],'payable':false,'stateMutability':'view','type':'function'},{'constant':false,'inputs':[{'internalType':'address','name':'receiver','type':'address'},{'internalType':'uint256','name':'numTokens','type':'uint256'}],'name':'transfer','outputs':[{'internalType':'bool','name':'','type':'bool'}],'payable':false,'stateMutability':'nonpayable','type':'function'},{'constant':false,'inputs':[{'internalType':'address','name':'holder','type':'address'},{'internalType':'address','name':'buyer','type':'address'},{'internalType':'uint256','name':'numTokens','type':'uint256'}],'name':'transferFrom','outputs':[{'internalType':'bool','name':'','type':'bool'}],'payable':false,'stateMutability':'nonpayable','type':'function'}]);var erc20_coin = erc20_coinContract.new(total,{from: web3.eth.accounts[0], data: '0x60806040523480156200001157600080fd5b506040516200142438038062001424833981810160405260208110156200003757600080fd5b8101908080519060200190929190505050336000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506000601260ff16600a0a60c80290508160038190555080601260ff16600a0a6003540203600160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000208190555060006200011b6040518060600160405280602a8152602001620013fa602a91396200016a60201b60201c565b905081600160008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550505050620003d7565b6000606082905060008090506000806000600290505b602a811015620003ca57610100840293508481815181106200019e57fe5b602001015160f81c60f81b60f81c60ff169250846001820181518110620001c157fe5b602001015160f81c60f81b60f81c60ff16915060618373ffffffffffffffffffffffffffffffffffffffff161015801562000213575060668373ffffffffffffffffffffffffffffffffffffffff1611155b156200022557605783039250620002c4565b60418373ffffffffffffffffffffffffffffffffffffffff161015801562000264575060468373ffffffffffffffffffffffffffffffffffffffff1611155b156200027657603783039250620002c3565b60308373ffffffffffffffffffffffffffffffffffffffff1610158015620002b5575060398373ffffffffffffffffffffffffffffffffffffffff1611155b15620002c2576030830392505b5b5b60618273ffffffffffffffffffffffffffffffffffffffff161015801562000303575060668273ffffffffffffffffffffffffffffffffffffffff1611155b156200031557605782039150620003b4565b60418273ffffffffffffffffffffffffffffffffffffffff161015801562000354575060468273ffffffffffffffffffffffffffffffffffffffff1611155b156200036657603782039150620003b3565b60308273ffffffffffffffffffffffffffffffffffffffff1610158015620003a5575060398273ffffffffffffffffffffffffffffffffffffffff1611155b15620003b2576030820391505b5b5b8160108402018401935060028101905062000180565b5082945050505050919050565b61101380620003e76000396000f3fe608060405234801561001057600080fd5b506004361061009e5760003560e01c806370a082311161006657806370a08231146102545780638da5cb5b146102ac57806395d89b41146102f6578063a9059cbb14610379578063dd62ed3e146103df5761009e565b806306fdde03146100a3578063095ea7b31461012657806318160ddd1461018c57806323b872dd146101aa578063313ce56714610230575b600080fd5b6100ab610457565b6040518080602001828103825283818151815260200191508051906020019080838360005b838110156100eb5780820151818401526020810190506100d0565b50505050905090810190601f1680156101185780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6101726004803603604081101561013c57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff16906020019092919080359060200190929190505050610490565b604051808215151515815260200191505060405180910390f35b610194610582565b6040518082815260200191505060405180910390f35b610216600480360360608110156101c057600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190803573ffffffffffffffffffffffffffffffffffffffff1690602001909291908035906020019092919050505061058c565b604051808215151515815260200191505060405180910390f35b610238610ad4565b604051808260ff1660ff16815260200191505060405180910390f35b6102966004803603602081101561026a57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050610ad9565b6040518082815260200191505060405180910390f35b6102b4610b22565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b6102fe610b47565b6040518080602001828103825283818151815260200191508051906020019080838360005b8381101561033e578082015181840152602081019050610323565b50505050905090810190601f16801561036b5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6103c56004803603604081101561038f57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff16906020019092919080359060200190929190505050610b80565b604051808215151515815260200191505060405180910390f35b610441600480360360408110156103f557600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050610f0b565b6040518082815260200191505060405180910390f35b6040518060400160405280600a81526020017f45524332305f436f696e0000000000000000000000000000000000000000000081525081565b600081600260003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508273ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925846040518082815260200191505060405180910390a36001905092915050565b6000600354905090565b6000806105a461271084610f9290919063ffffffff16565b9050600160008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020546105f98285610fab90919063ffffffff16565b111561060457600080fd5b600260008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020546106948285610fab90919063ffffffff16565b111561069f57600080fd5b610703816106f585600160008a73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054610fc790919063ffffffff16565b610fc790919063ffffffff16565b600160008773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055506107e7816107d985600260008a73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054610fc790919063ffffffff16565b610fc790919063ffffffff16565b600260008773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055506108b983600160008773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054610fab90919063ffffffff16565b600160008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508373ffffffffffffffffffffffffffffffffffffffff168573ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef856040518082815260200191505060405180910390a36000811115610ac8576109dd81600160008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054610fab90919063ffffffff16565b600160008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055506000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef836040518082815260200191505060405180910390a35b60019150509392505050565b601281565b6000600160008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050919050565b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b6040518060400160405280600581526020017f455243323000000000000000000000000000000000000000000000000000000081525081565b600080610b9861271084610f9290919063ffffffff16565b9050600160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054610bed8285610fab90919063ffffffff16565b1115610bf857600080fd5b610c5c81610c4e85600160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054610fc790919063ffffffff16565b610fc790919063ffffffff16565b600160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550610cf183600160008773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054610fab90919063ffffffff16565b600160008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508373ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef856040518082815260200191505060405180910390a36000811115610f0057610e1581600160008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054610fab90919063ffffffff16565b600160008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055506000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef836040518082815260200191505060405180910390a35b600191505092915050565b6000600260008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905092915050565b600080828481610f9e57fe5b0490508091505092915050565b600080828401905083811015610fbd57fe5b8091505092915050565b600082821115610fd357fe5b81830390509291505056fea265627a7a723158202d2e0cdcfd9e89a44c28e2b2b8a925e69373cb73faf83813566fd283e25661c964736f6c63430005110032305830434535393232354243443434374645414544363938454437353444333039464542413546433633', gas: '4700000'}, function (e, contract){console.log(e, contract);if (typeof contract.address !== 'undefined') {console.log('Contract mined! address: ' + contract.address + ' transactionHash: ' + contract.transactionHash);}})"

    
    geth --exec "$contract" attach http://$ip:8541 &> node1.log

    code=$(geth --exec "eth.getCode('0x70009254e451916fb5543d161768f489289384fb')" attach http://$ip:8541)

    while [ "$code" == "0x" ]
	do
		sleep 2
		echo "Waiting for contrract..."
        $code=$(geth --exec "eth.getCode('0x70009254e451916fb5543d161768f489289384fb')" attach http://$ip:8541)
        echo $code
	done

    echo "The node is ready!"
    sleep infinity